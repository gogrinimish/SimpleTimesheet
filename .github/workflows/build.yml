name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-ios:
    name: Build iOS
    runs-on: macos-15
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Select Latest Xcode
      run: |
        # List available Xcode versions
        ls /Applications/ | grep Xcode || true
        # Use the latest available Xcode
        XCODE_PATH=$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)
        echo "Using Xcode at: $XCODE_PATH"
        sudo xcode-select -s "$XCODE_PATH"
        xcodebuild -version
    
    - name: List Available Simulators
      run: xcrun simctl list devices available
    
    - name: Build iOS App
      run: |
        xcodebuild build \
          -project SimpleTimesheet.xcodeproj \
          -scheme SimpleTimesheet \
          -destination 'generic/platform=iOS Simulator' \
          -configuration Debug \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO
    
    - name: Run Tests
      run: |
        # Find an available iPhone simulator
        SIMULATOR_ID=$(xcrun simctl list devices available | grep "iPhone" | grep -v "unavailable" | head -1 | grep -oE '[A-F0-9-]{36}')
        if [ -z "$SIMULATOR_ID" ]; then
          echo "No iPhone simulator found, skipping tests"
          exit 0
        fi
        echo "Using simulator ID: $SIMULATOR_ID"
        xcodebuild test \
          -project SimpleTimesheet.xcodeproj \
          -scheme SimpleTimesheet \
          -destination "platform=iOS Simulator,id=$SIMULATOR_ID" \
          -enableCodeCoverage YES \
          -resultBundlePath TestResults.xcresult \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO
      continue-on-error: true
    
    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ios-test-results
        path: TestResults.xcresult
        retention-days: 7
        if-no-files-found: ignore

  build-macos:
    name: Build macOS
    runs-on: macos-15
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Select Latest Xcode
      run: |
        XCODE_PATH=$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)
        echo "Using Xcode at: $XCODE_PATH"
        sudo xcode-select -s "$XCODE_PATH"
        xcodebuild -version
    
    - name: Build macOS App
      run: |
        xcodebuild build \
          -project SimpleTimesheet.xcodeproj \
          -scheme SimpleTimesheetMac \
          -destination 'platform=macOS' \
          -configuration Debug \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO
    
    - name: Run macOS Tests
      run: |
        xcodebuild test \
          -project SimpleTimesheet.xcodeproj \
          -scheme SimpleTimesheetMac \
          -destination 'platform=macOS' \
          -enableCodeCoverage YES \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO
      continue-on-error: true

  lint:
    name: Lint
    runs-on: macos-15
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install SwiftLint
      run: brew install swiftlint
    
    - name: Run SwiftLint
      run: swiftlint lint --config .swiftlint.yml --reporter github-actions-logging
      continue-on-error: true
