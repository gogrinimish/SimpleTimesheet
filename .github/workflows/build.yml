name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  XCODE_VERSION: '16.0'
  IOS_SIMULATOR: 'iPhone 16'
  IOS_VERSION: '18.0'

jobs:
  build-ios:
    name: Build iOS
    runs-on: macos-14
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app
    
    - name: List Available Simulators
      run: xcrun simctl list devices available
    
    - name: Build iOS App
      run: |
        xcodebuild build \
          -project SimpleTimesheet.xcodeproj \
          -scheme SimpleTimesheet \
          -destination 'platform=iOS Simulator,name=${{ env.IOS_SIMULATOR }},OS=${{ env.IOS_VERSION }}' \
          -configuration Debug \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          | xcpretty --color
    
    - name: Run Tests with Coverage
      run: |
        xcodebuild test \
          -project SimpleTimesheet.xcodeproj \
          -scheme SimpleTimesheet \
          -destination 'platform=iOS Simulator,name=${{ env.IOS_SIMULATOR }},OS=${{ env.IOS_VERSION }}' \
          -enableCodeCoverage YES \
          -resultBundlePath TestResults.xcresult \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          | xcpretty --color
    
    - name: Generate Test Summary
      if: always()
      run: |
        if [ -d "TestResults.xcresult" ]; then
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          xcrun xcresulttool get --format json --path TestResults.xcresult | \
            python3 -c "
        import json, sys
        data = json.load(sys.stdin)
        metrics = data.get('metrics', {})
        tests_count = metrics.get('testsCount', {}).get('_value', 'N/A')
        tests_failed = metrics.get('testsFailedCount', {}).get('_value', '0')
        print(f'- **Total Tests**: {tests_count}')
        print(f'- **Failed Tests**: {tests_failed}')
        " >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "- Test results parsing skipped" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ios-test-results
        path: TestResults.xcresult
        retention-days: 7

  build-macos:
    name: Build macOS
    runs-on: macos-14
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app
    
    - name: Build macOS App
      run: |
        xcodebuild build \
          -project SimpleTimesheet.xcodeproj \
          -scheme SimpleTimesheetMac \
          -destination 'platform=macOS' \
          -configuration Debug \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          | xcpretty --color
    
    - name: Run macOS Tests
      run: |
        xcodebuild test \
          -project SimpleTimesheet.xcodeproj \
          -scheme SimpleTimesheetMac \
          -destination 'platform=macOS' \
          -enableCodeCoverage YES \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          | xcpretty --color
      continue-on-error: true  # macOS tests may have UI dependencies

  build-android:
    name: Build Android (Skip)
    runs-on: macos-14
    if: false  # Disabled until Skip is fully configured
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Install Skip
      run: brew install skiptools/skip/skip
    
    - name: Verify Skip Installation
      run: skip checkup
    
    - name: Build Android
      run: skip build --android
      continue-on-error: true

  lint:
    name: Lint
    runs-on: macos-14
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install SwiftLint
      run: brew install swiftlint
    
    - name: Run SwiftLint
      run: swiftlint lint --config .swiftlint.yml --reporter github-actions-logging
      continue-on-error: true
    
    - name: SwiftLint Summary
      if: always()
      run: |
        echo "## SwiftLint Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        swiftlint lint --config .swiftlint.yml --reporter markdown >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No issues found" >> $GITHUB_STEP_SUMMARY
